<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zrooms SSE Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: #f5f5f5; border-radius: 4px; padding: 15px; margin-bottom: 15px; }
        pre { background: #eee; padding: 10px; border-radius: 4px; overflow: auto; }
        .btn { background: #4CAF50; color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 4px; }
        .btn:hover { background: #45a049; }
        .status { margin-top: 10px; font-weight: bold; }
        .log { margin-top: 20px; background: #333; color: #fff; padding: 10px; border-radius: 4px; max-height: 300px; overflow: auto; }
        .payload { margin-top: 10px; padding: 10px; background: #e9f7ef; border-radius: 4px; }
        .input-group { margin-top: 15px; }
        .input-group input { width: 80%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Zrooms SSE Test</h1>
        
        <div class="card">
            <h2>SSE Connection Settings</h2>
            <div class="input-group">
                <label for="server-url">Server URL:</label>
                <input type="text" id="server-url" value="http://localhost:8080" />
            </div>
            <p class="hint">When running locally, use http://localhost:8080. For production, use the full URL like https://zrooms.nav.no</p>
            
            <button id="connect-btn" class="btn">Connect to SSE</button>
            <button id="disconnect-btn" class="btn" style="background: #f44336;">Disconnect</button>
            <button id="test-event-btn" class="btn" style="background: #2196F3;">Simulate Test Event</button>
            <div id="connection-status" class="status">Disconnected</div>
        </div>
        
        <div class="card">
            <h2>Test Event Payload</h2>
            <p>This is the example event that will be simulated:</p>
            <div class="payload">
                <pre>event:update
data:[{"id":"96722590573","topic":"AppSec \u0026 Friends","start_time":"0001-01-01T00:00:00Z","end_time":"2025-05-09T10:08:06.15140462+02:00","duration":0,"status":3,"host":{"id":"","name":"","email":"","join_time":"0001-01-01T00:00:00Z","leave_time":"0001-01-01T00:00:00Z"},"participants":[]}]</pre>
            </div>
        </div>
        
        <div class="card">
            <h2>Received Events</h2>
            <div id="events-container"></div>
        </div>
        
        <div class="log" id="debug-log">
            <!-- Debug logs will be displayed here -->
        </div>
    </div>
    
    <script>
        // State variables
        let abortController = null;
        let textBuffer = '';
        
        // DOM elements
        const serverUrlInput = document.getElementById('server-url');
        const connectBtn = document.getElementById('connect-btn');
        const disconnectBtn = document.getElementById('disconnect-btn');
        const testEventBtn = document.getElementById('test-event-btn');
        const statusEl = document.getElementById('connection-status');
        const eventsContainer = document.getElementById('events-container');
        const debugLog = document.getElementById('debug-log');
        
        // Set default server URL based on current location if loaded via HTTP
        if (window.location.protocol.startsWith('http')) {
            // Extract origin from current location
            const origin = window.location.origin;
            serverUrlInput.value = origin;
        }
        
        // Log function
        function log(message, isError = false) {
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            if (isError) {
                logEntry.style.color = '#ff6b6b';
            }
            debugLog.appendChild(logEntry);
            debugLog.scrollTop = debugLog.scrollHeight;
        }
        
        // Process SSE text chunks
        function processEventStream(text) {
            log(`Processing event stream chunk: ${text.length} bytes`);
            
            // Split the text into individual event chunks
            const eventChunks = text.split('\n\n');
            
            for (const chunk of eventChunks) {
                if (!chunk.trim()) continue;
                
                const lines = chunk.split('\n');
                let eventType = 'message';
                let data = '';
                let id = '';
                
                for (const line of lines) {
                    if (line.startsWith('event:')) {
                        eventType = line.substring(6).trim();
                    } else if (line.startsWith('data:')) {
                        data = line.substring(5).trim();
                    } else if (line.startsWith('id:')) {
                        id = line.substring(3).trim();
                    } else if (line.startsWith(':')) {
                        // This is a comment, used for keep-alive
                        log('Received keep-alive ping');
                        continue;
                    }
                }
                
                if (data) {
                    log(`Received ${eventType} event with data`);
                    
                    // Display the event
                    const eventEl = document.createElement('div');
                    eventEl.className = 'card';
                    eventEl.innerHTML = `
                        <h3>Event: ${eventType}</h3>
                        <pre>${data}</pre>
                        <div>Received at: ${new Date().toLocaleTimeString()}</div>
                    `;
                    eventsContainer.prepend(eventEl);
                    
                    // If it's the example update event, parse and validate it
                    if (eventType === 'update') {
                        try {
                            const meetings = JSON.parse(data);
                            log(`Successfully parsed ${meetings.length} meetings from update event`);
                            
                            // Validate the meeting data matches what we expect
                            if (meetings[0] && meetings[0].id === '96722590573') {
                                log('✅ Event contains the expected meeting ID: 96722590573');
                                
                                if (meetings[0].topic && meetings[0].topic.includes('AppSec')) {
                                    log('✅ Event contains the expected meeting topic: AppSec & Friends');
                                }
                            }
                        } catch (e) {
                            log(`Error parsing update event data: ${e.message}`, true);
                        }
                    }
                }
            }
        }
        
        // Get the base server URL
        function getServerUrl() {
            let url = serverUrlInput.value.trim();
            
            // Ensure URL doesn't end with a slash
            if (url.endsWith('/')) {
                url = url.slice(0, -1);
            }
            
            // Ensure URL starts with http:// or https://
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'http://' + url;
            }
            
            return url;
        }
        
        // Custom SSE connection function
        async function connectSSE() {
            // Reset UI
            statusEl.textContent = 'Connecting...';
            statusEl.style.color = '#f39c12';
            
            if (abortController) {
                abortController.abort();
            }
            
            // Create a new abort controller
            abortController = new AbortController();
            const signal = abortController.signal;
            
            textBuffer = '';
            
            try {
                // Get the server URL from input
                const serverUrl = getServerUrl();
                log(`Initiating SSE connection to ${serverUrl}/events...`);
                
                // Try using native EventSource first
                try {
                    log('Attempting to connect using native EventSource...');
                    
                    // Close any existing EventSource
                    if (window.eventSource) {
                        window.eventSource.close();
                        window.eventSource = null;
                    }
                    
                    // Create URL with timestamp to prevent caching
                    const sseUrl = `${serverUrl}/events?t=${Date.now()}`;
                    
                    // Create a new EventSource
                    const eventSource = new EventSource(sseUrl);
                    window.eventSource = eventSource;
                    
                    log(`EventSource connecting to: ${sseUrl}`);
                    
                    // Handle EventSource events
                    eventSource.addEventListener('open', function() {
                        log('EventSource connection opened');
                        statusEl.textContent = 'Connected (EventSource)';
                        statusEl.style.color = '#2ecc71';
                    });
                    
                    eventSource.addEventListener('connected', function(event) {
                        try {
                            const parsedData = JSON.parse(event.data);
                            log(`Connected event received. Client ID: ${parsedData.id}`);
                            
                            const eventEl = document.createElement('div');
                            eventEl.className = 'card';
                            eventEl.innerHTML = `
                                <h3>Event: connected</h3>
                                <pre>${event.data}</pre>
                                <div>Received at: ${new Date().toLocaleTimeString()}</div>
                            `;
                            eventsContainer.prepend(eventEl);
                        } catch (e) {
                            log(`Error parsing connected event: ${e.message}`, true);
                        }
                    });
                    
                    eventSource.addEventListener('update', function(event) {
                        log('Update event received');
                        try {
                            const meetings = JSON.parse(event.data);
                            log(`Successfully parsed ${meetings.length} meetings from update event`);
                            
                            // Display the event
                            const eventEl = document.createElement('div');
                            eventEl.className = 'card';
                            eventEl.innerHTML = `
                                <h3>Event: update</h3>
                                <pre>${event.data}</pre>
                                <div>Received at: ${new Date().toLocaleTimeString()}</div>
                            `;
                            eventsContainer.prepend(eventEl);
                            
                            // Validate meeting data
                            if (meetings[0] && meetings[0].id === '96722590573') {
                                log('✅ Event contains the expected meeting ID: 96722590573');
                                
                                if (meetings[0].topic && meetings[0].topic.includes('AppSec')) {
                                    log('✅ Event contains the expected meeting topic: AppSec & Friends');
                                }
                            }
                        } catch (e) {
                            log(`Error parsing update event: ${e.message}`, true);
                        }
                    });
                    
                    eventSource.addEventListener('error', function(error) {
                        log('EventSource error occurred', true);
                        console.error('EventSource error:', error);
                        eventSource.close();
                        window.eventSource = null;
                        
                        // Only attempt fetch fallback if this wasn't a manual disconnect
                        if (abortController) {
                            log('Falling back to fetch-based approach...');
                            useFetchFallback();
                        }
                    });
                    
                    // Don't proceed to fetch fallback if EventSource worked
                    return;
                    
                } catch (e) {
                    log(`EventSource failed: ${e.message}. Falling back to fetch.`, true);
                    // Continue with fetch fallback
                }
                
                // Fetch-based fallback approach
                function useFetchFallback() {
                    log('Using fetch-based SSE approach');
                    
                    // Create URL with timestamp to prevent caching
                    const sseUrl = `${serverUrl}/events?t=${Date.now()}`;
                    log(`Fetch connecting to: ${sseUrl}`);
                    
                    fetch(sseUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'text/event-stream',
                            'Cache-Control': 'no-cache'
                        },
                        credentials: 'same-origin', 
                        cache: 'no-store',
                        signal: signal
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        
                        log('SSE fetch connection established');
                        statusEl.textContent = 'Connected (Fetch)';
                        statusEl.style.color = '#2ecc71';
                        
                        // Get the reader to process the stream
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        
                        // Process the stream
                        function readStream() {
                            reader.read().then(({ value, done }) => {
                                if (done) {
                                    log('SSE stream complete');
                                    return;
                                }
                                
                                // Decode the chunk and add it to our buffer
                                const chunk = decoder.decode(value, { stream: true });
                                textBuffer += chunk;
                                
                                // Process complete events
                                if (textBuffer.includes('\n\n')) {
                                    processEventStream(textBuffer);
                                    
                                    // Keep only the incomplete part
                                    const lastIndex = textBuffer.lastIndexOf('\n\n');
                                    if (lastIndex !== -1) {
                                        textBuffer = textBuffer.substring(lastIndex + 2);
                                    }
                                }
                                
                                // Continue reading
                                readStream();
                            }).catch(error => {
                                if (error.name !== 'AbortError') {
                                    log(`Error reading SSE stream: ${error.message}`, true);
                                    statusEl.textContent = 'Connection Failed';
                                    statusEl.style.color = '#e74c3c';
                                }
                            });
                        }
                        
                        // Start reading
                        readStream();
                    })
                    .catch(error => {
                        if (error.name !== 'AbortError') {
                            log(`SSE connection error: ${error.message}`, true);
                            statusEl.textContent = 'Connection Failed';
                            statusEl.style.color = '#e74c3c';
                            
                            // Add specific troubleshooting advice
                            log(`
Troubleshooting tips:
1. Check if the server is running at ${serverUrl}
2. Verify the /events endpoint is accessible
3. Check browser console for CORS errors
4. Make sure SSE is properly implemented on the server`, true);
                        } else {
                            log('Connection aborted by user');
                        }
                    });
                }
                
                // Try the fetch fallback
                useFetchFallback();
                
            } catch (error) {
                if (error.name !== 'AbortError') {
                    log(`SSE connection error: ${error.message}`, true);
                    statusEl.textContent = 'Connection Failed';
                    statusEl.style.color = '#e74c3c';
                } else {
                    log('Connection aborted by user');
                }
            }
        }
        
        // Disconnect from SSE
        function disconnectSSE() {
            if (window.eventSource) {
                window.eventSource.close();
                window.eventSource = null;
            }
            
            if (abortController) {
                abortController.abort();
                abortController = null;
            }
            
            statusEl.textContent = 'Disconnected';
            statusEl.style.color = '#7f8c8d';
            log('Disconnected from SSE');
        }
        
        // Simulate the test event
        function simulateTestEvent() {
            log('Simulating test event...');
            
            const testEvent = `event:update
data:[{"id":"96722590573","topic":"AppSec \\u0026 Friends","start_time":"0001-01-01T00:00:00Z","end_time":"2025-05-09T10:08:06.15140462+02:00","duration":0,"status":3,"host":{"id":"","name":"","email":"","join_time":"0001-01-01T00:00:00Z","leave_time":"0001-01-01T00:00:00Z"},"participants":[]}]
`;
            
            // Process the event directly
            processEventStream(testEvent);
            log('Test event processed');
        }
        
        // Attach event listeners
        connectBtn.addEventListener('click', connectSSE);
        disconnectBtn.addEventListener('click', disconnectSSE);
        testEventBtn.addEventListener('click', simulateTestEvent);
        
        // Initial log
        log('SSE Test page loaded. Use the Connect button to start connection.');
    </script>
</body>
</html>